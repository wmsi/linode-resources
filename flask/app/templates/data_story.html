{% extends "base.html" %}

{% block content %}
    <h1>Raw Data</h1>

    {# raw #}
    {# endraw #}
    <form>
    <div class="row">
        <div class="col main-panel">
            <div class="row">
                <div class="col-md-4">
                    <label>Select your Project ID</label>
                    <select class="form-control form-control-lg" id="project_id" onchange="renderTable(true)">
                        <option value="">Select Project ID</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label>Select your Data Type</label>
                    <select class="form-control form-control-lg" id="data_type" onchange="renderTable()">
                        <option value="">Select Data Type</option>
                    </select>
                </div>
               <!--  <div class="col-md-4">
                    <label>Select your Sensor ID</label>
                    <select class="form-control form-control-lg" id="data_type" onchange="renderTable()">
                        <option value="">Select Sensor ID</option>
                    </select>
                </div> -->
                <div class="col-md-4 form-group">
                    <label>Choose a Date Range</label><br>
                    <div id="datepicker" class="pull-right datepicker form-control form-control-lg">
                        <i class="glyphicon glyphicon-calendar fa fa-calendar"></i>&nbsp;
                        <span></span> <b class="caret"></b>
                    </div>

                    <!-- <input class="form-control corm-control-lg" type="text" value="01/01/2018 - 03/31/2018" /> -->
                </div>
            </div>
        </div>
        <!-- <div class="col sensor-panel">
            <label>Select Sensors</label>
            <div class="col-md-6 form-check form-control form-control-lg">
                <input class="form-check-input" type="checkbox" value="" id="defaultCheck1">
                <label class="form-check-label" for="defaultCheck1">
                Sensor 1
                </label>
            </div>
        </div> -->
    </div>
    </form>

    <div class="row">
        <div class="col-md-8">
            <canvas id="chartCanvas" width="400" height="400"></canvas>
        </div>
        <div class="col-md-4">
            <div class="sensor_id">

            </div>
            <a href='#' class='form-control btn' onclick='renderChart()'>Update Chart</a>
            <br>
            <div class="auto_refresh">
                Refresh Automatically: <input type="checkbox" id="auto_refresh">
            </div>
        </div>
    </div>

    <table class="table center" border="2" id="data-table"><!-- class="lead table table-responsive" -->
        <thead>
            <tr><b>
                <th>Project ID</th>
                <th>Timestamp</th>
                <th>Value</th>
                <th>Data Type</th>
            </tr></b>
        </thead>
        <tbody id='table-content'>
            {% block topic %}
                
                {% for data in datastory %}
                <tr>
                    <td>{{ data.project_id }}</td>
                    <td>{{ data.timestamp|datetime }}</td> <!-- format timestamp -->
                    <td>{{ data.value }}</td>
                    <td>{{ data.data_type }}</td>
                </tr>
                {% endfor %}
            {% endblock %}
        </tbody>
    </table>
    <br>
    {% if current_user.wmsi_user %}
    <p class="lead"><a href="#" class="btn btn-default">Edit Data Stories</a></p>
    {% endif %}
{% endblock %}

{% block script %}
    <!-- script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>

    <script>
        var raw_data = [];

        {% for data in datastory %}
            raw_data.push({
                "project_id":{{ data.project_id }}, 
                "sensor_id":{{ data.sensor_id }},
                // "timestamp": "{{ data.timestamp|datetime }}",
                "timestamp":moment("{{ data.timestamp|datetime }}", "ddd DD-MM-YYYY HH:mm:ss"),
                "value":{{ data.value }},
                "data_type":"{{ data.data_type }}"
            });
        {% endfor %}
        // render_data = raw_data;
        var start_date = getFirstDate(raw_data); // = new Date();
        var end_date = getLastDate(raw_data); // = raw_data Date();


        // pull new data from the server and save the most recent timestamp
        $(function() {
            var since = getLastDate(raw_data).unix();
            setInterval(function() {
                $.ajax("{{ url_for('get_new_data') }}?since=" + since).done(
                    function(new_data) {
                        // console.log('get data since ' + since);
                        for (var i = 0; i < new_data.length; i++) {
                            new_data[i].timestamp = moment.unix(new_data[i].timestamp);
                            // console.log(JSON.stringify(new_data[i]));
                            raw_data.push(new_data[i]);
                            
                            since = new_data[i].timestamp.unix()+1;
                            // console.log('new since: ' + String(since));
                            renderTable();
                            if(document.getElementById("auto_refresh").checked) {
                                end_date = getLastDate(raw_data);
                                renderChart();
                            }
                        }
                    }
                );
            }, 5000);
        });

        function renderSelects() {
            // var id_options = $.unique(raw_data.map(function (d) {return d.project_id}));
            var id_options = [];
            $.each(raw_data, function(i, el) {
                if($.inArray(el.project_id, id_options) === -1) id_options.push(el.project_id);
            });
            $('#project_id').append(
                $.map(id_options, function(item, index) {
                    return '<option value="' + item + '">' + item + '</option>';
                }).join());

            // id_options = $.unique(raw_data.map(function (d) {return d.sensor_id}));
            // $('#project_id').append(
            //     $.map(id_options, function(item, index) {
            //         return '<option value="' + item + '">' + item + '</option>';

            var type_options = $.unique(raw_data.map(function (d) {return d.data_type}));
            $('#data_type').append(
                $.map(type_options, function(item, index) {
                    return '<option value="' + item + '">' + item + '</option>';
                }).join());      
        }

        function getFirstDate(data_array) {
            var first_date = moment(data_array[0].timestamp);
            for(i=1; i<data_array.length; i++) {
                if(moment(data_array[i].timestamp).isBefore(first_date)) {
                    first_date = moment(data_array[i].timestamp);
                }
            }
            return first_date;
        }

        function getLastDate(data_array) {
            var last_date = moment(data_array[0].timestamp);
            for(i=1; i<data_array.length; i++) {
                if(moment(data_array[i].timestamp).isAfter(last_date)) {
                    last_date = moment(data_array[i].timestamp);
                }
            }
            return last_date;
        }
        

        function filterData(set_dates=false) {
            var render_data = raw_data;

            // first filter by project ID
            var filter_id = document.getElementById("project_id").value;
            if (filter_id != "Select Project ID" && filter_id != "") {
                render_data = render_data.filter(function (el) {
                        return el.project_id == filter_id;
                    });
            }

            // now filter by sensor ID
            // filter_id = document.getElementById("sensor_id").value;
            // if (filter_id != "Select Sensor ID" && sensor_id != "") {
            //     render_data = render_data.filter(function (el) {
            //             return el.sensor_id == filter_id;
            //         });
            // }

            var filter_type = document.getElementById("data_type").value;
            if (filter_type != "Select Data Type" && filter_type != "") {
                render_data = render_data.filter(function (el) { // var filter_by_id = 
                        return el.data_type == filter_type;
                    });
            }

            if(set_dates) {
                autoSetDates(render_data);
            }

            if(start_date && end_date) {
                render_data = filterDate(render_data);
            }

            return render_data;
        }

        function filterDate(render_data) {
            render_data = render_data.filter(function (el) {
                // timestamp = new Date(el.timestamp);
                timestamp = moment(el.timestamp);
                return (timestamp.isAfter(start_date-1) && timestamp.isBefore(end_date+1));
                // return (timestamp >= start_date && timestamp <= end_date);
            });
            return render_data;
        }

        function renderTable(set_dates=false) {
            render_data = filterData(set_dates);

            $('#table-content').html(
                $.map(render_data, function(item, index) {
                    return '<tr><td>' + item.project_id + '</td><td>' + item.timestamp.format('MMMM Do YYYY, h:mm:ss a') + '</td><td>' + item.value + '</td><td>' + item.data_type + '</td></tr>';
                }).join());

            // var sensor_options = $.unique(render_data.map(function (d) {return d.sensor_id}));
            // $('#sensor_id').append(
            //     $.map(type_options, function(item, index) {
            //         return '<input type="checkbox" value="Sensor ' + item + '"><label>Sensor ' + item + '</label><br>';
            //     }).join()); 
        }

        function autoSetDates(render_data) {
            start_date = getFirstDate(render_data);
            end_date = getLastDate(render_data);
            $('#datepicker span').html(start_date.format('MMMM D, YYYY') + ' - ' + end_date.format('MMMM D, YYYY'));
        }

    // render dropdowns when the page loads

        /* date range picker config */
        /* from www.daterangepicker.com */
        $(function() {
            var start = start_date; //moment().subtract(29, 'days');
            var end = end_date; //moment();

            function cb(start, end) {
                $('#datepicker span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
                // console.log("A new date range was chosen: " + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD'));
                // filterDate(start, end);
                start_date = start;
                end_date = end;
                renderTable();
            }

            $('#datepicker').daterangepicker({
                startDate: start,
                endDate: end,
                ranges: {
                   'Today': [moment(), moment()],
                   'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                   'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                   'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                   'This Month': [moment().startOf('month'), moment().endOf('month')],
                   'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                }
            }, cb);

            cb(start, end);
        });


    window.onload = renderSelects();

    const canvas = document.getElementById('chartCanvas');
    const ctx = document.getElementById('chartCanvas').getContext('2d');
    ctx.fillStyle = 'black';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    // window.onload = renderChart();

    function renderChart() {
        render_data = filterData();
        if(!singleType(render_data)) {
            ctx.font = "36px Roboto";
            ctx.fillText("Please select a single Data Type",10,50);
            cts.fillTexct(" to render a chart",10,70);
            return;
        }
        if(document.getElementById('project_id').value == "Select Project ID") {
            ctx.font = "36px Roboto";
            ctx.fillText("Please select a Project ID",10,50);
            cts.fillTexct(" to render a chart",10,70);
            return;
        }
    
        // add data type error handling here
        const line_colors = ['#F15854', '#5DA5DA', '#DECF3F', '#B276B2', '#B2912F', '#F17CB0', '#60BD68', '#FAA43A', '#4D4D4D'];
        var y_label = render_data[0].data_type;
        var chart_projects = [];
        var data = {
            labels: [],
            // labels: [new Date(getFirstDate(test_data)), new Date(getLastDate(test_data))],
            datasets: [],
        }

        render_data.map(function(item) {
            if(!chart_projects.includes(item.project_id)) {
                var index = chart_projects.length;
                chart_projects.push(item.project_id);
                data.labels.push(new Date(item.timestamp));
                data.datasets.push({
                    fill: false,
                    label: item.data_type + " from Project " + item.project_id,
                    data: [item.value],
                    borderColor: line_colors[index],
                    backgroundColor: line_colors[index],
                    lineTension: 0,
                });
            } else {
                var index = chart_projects.indexOf(item.project_id);
                data.labels.push(new Date(item.timestamp));
                data.datasets[index].data.push(item.value);
            }
        });

        var options = {
            type: 'line',
            data: data,
            options: {
                fill: false,
                responsive: true,
                scales: {
                    xAxes: [{
                        type: 'time',
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: "Date",
                        }
                    }],
                    yAxes: [{
                        ticks: {
                            beginAtZero: false,
                        },
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: y_label,
                        }
                    }]
                }
            }
        }
        var myChart = new Chart(ctx, options);
    }

    function singleType(data) {
        var type = data[0].data_type;
        for(var i in data) {
            if(data[i].data_type != type) {
                return false;
            }
        }
        return true;
    }

// socketio uses websocket, which is not supported by apache
// if we reach the point of requiring immediate server updates
// we could look into implementing this

        // var socket = io.connect('https://' + document.domain + ':' + location.port);
        // console.log('socket at https://' + document.domain + ':' + location.port);
        // socket.on('connect', function() {
        //     socket.emit('my event', {data: 'I\'m connected!'});
        //     console.log('socket connected');
        // });
        // socket.on('test response', function() {
        //     console.log('test response');
        // });
        // socket.on('new value', function(data) {
        //     var new_val = JSON.parse(data);
        //     raw_data.push({
        //         "project_id": new_val.project_id,
        //         "sensor_id": new_val.sensor_id,
        //         "timestamp": moment(new_val.timestamp, "ddd DD-MM-YYYY HH:mm:ss"),
        //         "value": new_val.value,
        //         "data_type": new_val.data_type
        //     });
        //     console.log('new val: ', raw_data[raw_data.length-1]);
        //     renderTable(true);
        //     if(document.getElementById("auto_refresh").checked) {
        //         renderChart();
        //     }
        // });
    </script>
{% endblock %}
