{% extends "base.html" %}

{% block content %}
    <h1>Raw Data</h1>

    {# raw #}
    {# endraw #}
    <form>
    <div class="row">
        <div class="col main-panel">
            <div class="row">
                <div class="col-md-6">
                    <label>Select your Project ID</label>
                <!-- <div class="selector" align="left"> -->
                    <select class="form-control form-control-lg" id="project_id" onload="renderDropdown()" onchange="filterID(this)">
                        <option value="">Select Project ID</option>
                    </select>
                <!-- </div> -->
                </div>
                <div class="col-md-6 form-group">
                    <label>Choose a Date Range</label><br>
                    <div id="datepicker" class="pull-right datepicker form-control form-control-lg">
                        <i class="glyphicon glyphicon-calendar fa fa-calendar"></i>&nbsp;
                        <span></span> <b class="caret"></b>
                    </div>

                    <!-- <input class="form-control corm-control-lg" type="text" value="01/01/2018 - 03/31/2018" /> -->
                </div>
            </div>
        </div>
        <div class="col sensor-panel">
            <label>Select Sensors</label>
            <div class="col-md-6 form-check form-control form-control-lg">
                <input class="form-check-input" type="checkbox" value="" id="defaultCheck1">
                <label class="form-check-label" for="defaultCheck1">
                Sensor 1
                </label>
            </div>
        </div>
    </div>
    </form>
   
    <table class="table center" border="2" id="data-table"><!-- class="lead table table-responsive" -->
        <thead>
            <tr><b>
                <th>Project ID</th>
                <th>Timestamp</th>
                <th>Value</th>
                <th>Data Type</th>
            </tr></b>
        </thead>
        <tbody id='table-content'>
            {% block topic %}
                
                {% for data in datastory %}
                <tr>
                    <td>{{ data.project_id }}</td>
                    <td>{{ data.timestamp|datetime }}</td> <!-- format timestamp -->
                    <td>{{ data.value }}</td>
                    <td>{{ data.data_type }}</td>
                </tr>
                {% endfor %}
            {% endblock %}
        </tbody>
    </table>
    <br>
    {% if current_user.wmsi_user %}
    <p class="lead"><a href="#" class="btn btn-default">Edit Data Stories</a></p>
    {% endif %}
{% endblock %}

{% block script %}
    <!-- script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script -->
    <script>
        var raw_data = [];
        var render_data = [];
        var start_date = new Date();
        var end_date = new Date();

        {% for data in datastory %}
            raw_data.push({
                "project_id":"{{ data.project_id }}", 
                // "timestamp": "{{ data.timestamp|datetime }}",
                "timestamp": moment("{{ data.timestamp|datetime }}", "ddd DD-MM-YYYY HH:mm:ss"),
                "value":"{{ data.value }}",
                "data_type":"{{ data.data_type }}"
            });
        {% endfor %}
        render_data = raw_data;

        var options = $.unique(raw_data.map(function (d) {return d.project_id}));
        $('#project_id').append(
            $.map(options, function(item, index) {
                return '<option value="' + item + '">' + item + '</option>';
            }).join());

        function filterID(selectObject) {
            var filter_id = selectObject.value;
            var trHTML = "";
            render_data = render_data.filter(function (el) { // var filter_by_id = 
                    return el.project_id == filter_id;
                });
            renderTable();
        }

        function filterDate(start, end) {
            render_data = render_data.filter(function (el) {
                timestamp = new Date(el.timestamp);
                console.log("check if " + String(timestamp) + " is between " + String(start_date) + " and " + String(end_date));
                return (timestamp >= start && timestamp <= end);
            });
            renderTable();
        }

        function renderTable() {
            $('#table-content').html(
                $.map(render_data, function(item, index) {
                    return '<tr><td>' + item.project_id + '</td><td>' + item.timestamp.format('MMMM Do YYYY, h:mm:ss a') + '</td><td>' + item.value + '</td><td>' + item.data_type + '</td>';
                }).join());
        }

        /* date range picker config */
        /* from www.daterangepicker.com */
        $(function() {
            var start = moment().subtract(29, 'days');
            var end = moment();

            function cb(start, end) {
                $('#datepicker span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
                console.log("A new date range was chosen: " + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD'));
                filterDate(start, end);
                start_date = start;
                end_date = end;
            }

            $('#datepicker').daterangepicker({
                startDate: start,
                endDate: end,
                ranges: {
                   'Today': [moment(), moment()],
                   'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                   'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                   'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                   'This Month': [moment().startOf('month'), moment().endOf('month')],
                   'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                }
            }, cb);

            cb(start, end);
        });
    </script>
{% endblock %}